input {
  jdbc {
    jdbc_connection_string => "jdbc:postgresql://${POSTGRES_HOST}/${POSTGRES_DB}?sslmode=require&channel_binding=require"
    jdbc_user => "${POSTGRES_USER}"
    jdbc_password => "${POSTGRES_PASSWORD}"
    jdbc_driver_library => "/usr/share/logstash/logstash_internal/postgresql-42.6.2.jar"
    jdbc_driver_class => "org.postgresql.Driver"

    statement => "
      SELECT
          p.id::int,
          p.name,
          p.description,
          p.material,
          p.is_active,
          p.category_id::int,
          p.brand_id::int,
          -- image_urls через подзапрос, сразу приводим к text
          COALESCE(
              (SELECT json_agg(DISTINCT img)::text
               FROM unnest(p.image_urls) AS img),
              '[]'
          ) AS image_urls,
          -- video_urls через подзапрос
          COALESCE(
              (SELECT json_agg(DISTINCT vid)::text
               FROM unnest(p.video_urls) AS vid),
              '[]'
          ) AS video_urls,
          -- variants
          COALESCE(
              json_agg(
                  json_build_object(
                      'variant_id', v.id::int,
                      'sku', v.sku,
                      'price', v.price::double precision,
                      'discount', v.discount::double precision,
                      'sizes', v.sizes,
                      'colors', v.colors,
                      'stock', v.stock::int,
                      'rating', 0,
                      'review_count', 0,
                      'barcode', v.barcode,
                      'dimensions', v.dimensions,
                      'image_urls', COALESCE(v.image_urls, '{}'),
                      'min_order', v.min_order::int,
                      'is_active', v.is_active
                  ) ORDER BY v.id
              ) FILTER (WHERE v.id IS NOT NULL)::text,
              '[]'
          ) AS variants
      FROM products p
      LEFT JOIN product_variants v ON v.product_id = p.id
      GROUP BY p.id
      ORDER BY p.id
    "

    jdbc_paging_enabled => true
    jdbc_page_size => 1000
  }
}

filter {
  # Преобразуем JSON строки в объекты
  json {
    source => "image_urls"
    target => "image_urls"
  }

  json {
    source => "video_urls"
    target => "video_urls"
  }

  json {
    source => "variants"
    target => "variants"
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "products"
    document_id => "%{id}"
  }
  stdout { codec => rubydebug }
}
